<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BOJA Checker</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
body{font-family:sans-serif;background:#f8f9fa;margin:2rem;}
h1{color:#005500;}
button{background:#28a745;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;}
button:hover{background:#218838;}
#resultado{margin-top:2rem;white-space:pre-wrap;}
mark{background:#9f9;}
</style>
</head>
<body>
<h1>üìú Comprobador BOJA</h1>
<p>Pulsa el bot√≥n para buscar la frase en el √∫ltimo sumario del BOJA.</p>
<button id="buscar">Buscar frase</button>

<div id="info"></div>
<div id="resultado"></div>

<script>
const fraseObjetivo = "Subvenciones en r√©gimen de concurrencia no competitiva a organizaciones sindicales para la financiaci√≥n de gastos corrientes";

document.getElementById("buscar").addEventListener("click", async ()=>{
  const info = document.getElementById("info");
  const resultado = document.getElementById("resultado");
  info.textContent = "Buscando √∫ltimo BOJA...";
  resultado.textContent = "";

  try{
    // 1. Obtener HTML principal
    const resp = await fetch("https://www.juntadeandalucia.es/boja/");
    const text = await resp.text();

    // 2. Encontrar enlace al √∫ltimo BOJA
    const match = text.match(/href="(\/eboja\/\d{4}\/\d+\/index\.html)"/);
    if(!match){ info.textContent="‚ùå No se pudo localizar el √∫ltimo bolet√≠n."; return; }
    const urlBoletin = "https://www.juntadeandalucia.es" + match[1];
    info.innerHTML = `‚û°Ô∏è √öltimo bolet√≠n: <a href="${urlBoletin}" target="_blank">${urlBoletin}</a>`;

    // 3. Obtener la p√°gina del bolet√≠n y buscar PDF del sumario
    const resp2 = await fetch(urlBoletin);
    const htmlBoja = await resp2.text();
    const matchPdf = htmlBoja.match(/href="([^"]+sumario[^"]+\.pdf)"/i);
    if(!matchPdf){ info.textContent="‚ùå No se encontr√≥ el PDF del sumario."; return; }
    let urlPdf = matchPdf[1];
    if(!urlPdf.startsWith("http")) urlPdf = new URL(urlPdf, urlBoletin).href;

    info.innerHTML += `<br>üìÑ Descargando sumario: <a href="${urlPdf}" target="_blank">${urlPdf}</a>`;

    // 4. Descargar PDF y extraer texto con pdf.js
    const pdfBytes = await fetch(urlPdf).then(r=>r.arrayBuffer());
    const pdf = await pdfjsLib.getDocument({data: pdfBytes}).promise;
    let texto = "";
    for(let i=1;i<=pdf.numPages;i++){
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      texto += content.items.map(it=>it.str).join(" ") + "\n";
    }

    // 5. Buscar frase (b√∫squeda aproximada muy simple)
    const textoLower = texto.toLowerCase();
    const fraseLower = fraseObjetivo.toLowerCase();
    const pos = textoLower.indexOf(fraseLower);
    let similitud = 0;

    if(pos >= 0){
      similitud = 100;
      texto = texto.slice(0,pos) + "<mark>" +
               texto.slice(pos, pos+fraseObjetivo.length) +
               "</mark>" + texto.slice(pos+fraseObjetivo.length);
    }else{
      // Coincidencia parcial: contar palabras presentes
      const palabras = fraseLower.split(" ");
      const coincidencias = palabras.filter(p=>textoLower.includes(p));
      similitud = Math.round((coincidencias.length / palabras.length) * 100);
    }

    // 6. Mostrar resultados
    resultado.innerHTML = `<p><b>Similitud:</b> ${similitud}%</p>
                           <hr>${texto}`;
  }catch(err){
    info.textContent = "‚ùå Error: " + err;
  }
});
</script>
</body>
</html>
