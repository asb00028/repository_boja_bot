<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BOJA Checker Mejorado</title>
<style>
body { font-family: sans-serif; background: #f8f9fa; margin: 2rem; color: #222; }
h1 { color: #005500; margin-bottom: 2rem; }
#controls { display: flex; flex-direction: column; gap: 1rem; max-width: 700px; }
input[type="text"] { padding: 10px; font-size: 1rem; border: 1px solid #ccc; border-radius: 6px; width: 100%; }
button { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; width: fit-content; }
button:hover { background: #218838; }
#info { margin-top: 2rem; font-weight: bold; }
#resultado { margin-top: 2rem; line-height: 1.6; white-space: pre-wrap; }
mark { background: #9f9; font-weight: bold; }
</style>
</head>
<body>
<h1>üìú Comprobador BOJA Mejorado</h1>

<div id="controls">
  <label for="textoBuscado"><b>Texto a buscar:</b></label>
  <input id="textoBuscado" type="text" placeholder="Escribe aqu√≠ la frase que quieres buscar">
  <button id="buscar">Buscar frase en el sumario</button>
</div>

<div id="info"></div>
<div id="resultado"></div>

<script>
document.getElementById("buscar").addEventListener("click", async () => {
  const frase = document.getElementById("textoBuscado").value.trim();
  const info = document.getElementById("info");
  const resultado = document.getElementById("resultado");
  info.textContent = "";
  resultado.textContent = "";

  if (!frase) { info.textContent = "‚ö†Ô∏è Escribe un texto antes de buscar."; return; }

  info.textContent = "üîç Cargando sumario...";
  try {
    let texto = await fetch("sumario.txt").then(r => r.text());

    // ----------- LIMPIEZA DEL TEXTO -----------
    // separar en l√≠neas
    let lineas = texto.split(/\r?\n/);
    lineas = lineas.map(l => l.trim())
      .filter(l => l.length > 1) // eliminar l√≠neas vac√≠as o muy cortas
      .filter(l => !/^[a-zA-Z0-9]$/.test(l)) // eliminar l√≠neas con solo una letra o n√∫mero
      .filter(l => !/^https?:\/\//i.test(l)); // eliminar URLs

    // Concatenar l√≠neas cortas para menos saltos de l√≠nea
    const MIN_PALABRAS = 5;
    let limpio = [];
    let buffer = "";
    for (const l of lineas) {
      const palabras = l.split(/\s+/).length;
      if ((buffer.split(/\s+/).length + palabras) < MIN_PALABRAS) {
        buffer += (buffer ? " " : "") + l;
      } else {
        if (buffer) limpio.push(buffer);
        buffer = l;
      }
    }
    if (buffer) limpio.push(buffer);

    texto = limpio.join("\n");

    // ----------- RESALTAR TODAS LAS COINCIDENCIAS -----------
    const regex = new RegExp(frase.replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&'), "gi");
    let coincidencias = texto.match(regex);
    let similitud = coincidencias ? 100 : 0;
    texto = texto.replace(regex, match => `<mark>${match}</mark>`);

    resultado.innerHTML = `<p><b>Similitud:</b> ${similitud}%</p><hr>${texto}`;
    info.textContent = `‚úÖ Sumario cargado y analizado. ${coincidencias ? coincidencias.length + " coincidencias encontradas." : "No se encontraron coincidencias."}`;
  } catch(err) {
    info.textContent = "‚ùå Error: " + err;
  }
});
</script>
</body>
</html>
