<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BOJA Checker Inteligente</title>
<style>
body { font-family: sans-serif; background: #f8f9fa; margin: 2rem; color: #222; }
h1 { color: #005500; margin-bottom: 2rem; }
#controls { display: flex; flex-direction: column; gap: 1rem; max-width: 800px; }
input[type="text"] { padding: 10px; font-size: 1rem; border: 1px solid #ccc; border-radius: 6px; width: 100%; }
button { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; width: fit-content; }
button:hover { background: #218838; }
#info { margin-top: 2rem; font-weight: bold; }
#resultado { margin-top: 2rem; line-height: 1.6; white-space: pre-wrap; }
mark { background: #9f9; font-weight: bold; }
</style>
</head>
<body>
<h1>üìú Comprobador BOJA Inteligente</h1>

<div id="controls">
  <label for="textoBuscado"><b>Texto a buscar:</b></label>
  <input id="textoBuscado" type="text" 
         placeholder="Escribe la frase a buscar" 
         value="Subvenciones en r√©gimen de concurrencia no competitiva a organizaciones sindicales para la financiaci√≥n de gastos corrientes">
  <button id="buscar">Buscar frase en el sumario</button>
</div>

<div id="info"></div>
<div id="resultado"></div>

<script>
// ------- Normalizar texto (quita tildes, may√∫sculas, signos) -------
function normalizarTexto(t) {
  return t
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[.,;:()¬ø?!¬°"]/g, "")
    .replace(/\s+/g, " ")
    .trim();
}

// ------- Calcular similitud de frases -------
function calcularSimilitud(texto, frase) {
  const t = normalizarTexto(texto);
  const f = normalizarTexto(frase);

  if (t.includes(f)) return { score: 100, match: f };

  const palabrasT = t.split(" ");
  const palabrasF = f.split(" ");
  const total = palabrasF.length;

  let mejorScore = 0;
  let mejorInicio = 0;
  let mejorFin = 0;

  for (let i = 0; i < palabrasT.length; i++) {
    let score = 0;
    let consecutivas = 0;
    for (let j = 0; j < palabrasF.length && i + j < palabrasT.length; j++) {
      const a = palabrasT[i + j];
      const b = palabrasF[j];
      if (!a || !b) break;

      if (a === b) {
        score += 1;
        consecutivas++;
      } else if (a.startsWith(b.slice(0, 3)) || b.startsWith(a.slice(0, 3))) {
        score += 0.7;
        consecutivas = 0;
      } else {
        score -= 0.4; // penalizaci√≥n por palabra incorrecta
        consecutivas = 0;
      }
    }

    // Bonus si hay muchas consecutivas correctas
    score += consecutivas * 0.3;

    const porcentaje = Math.max(0, Math.min(100, Math.round((score / total) * 100)));
    if (porcentaje > mejorScore) {
      mejorScore = porcentaje;
      mejorInicio = i;
      mejorFin = i + palabrasF.length;
    }
  }

  // reconstruir el fragmento m√°s parecido
  const match = palabrasT.slice(mejorInicio, mejorFin).join(" ");
  return { score: mejorScore, match };
}

// ------- Procesar b√∫squeda -------
document.getElementById("buscar").addEventListener("click", async () => {
  const frase = document.getElementById("textoBuscado").value.trim();
  const info = document.getElementById("info");
  const resultado = document.getElementById("resultado");
  info.textContent = "";
  resultado.textContent = "";

  if (!frase) { info.textContent = "‚ö†Ô∏è Escribe un texto antes de buscar."; return; }

  info.textContent = "üîç Cargando y analizando sumario...";
  try {
    let texto = await fetch("sumario.txt").then(r => r.text());

    // --- Limpieza ---
    let lineas = texto.split(/\r?\n/)
      .map(l => l.trim())
      .filter(l => l.length > 1)
      .filter(l => !/^[a-zA-Z0-9]$/.test(l))
      .filter(l => !/^https?:\/\//i.test(l));

    // Unir l√≠neas cortas
    const MIN_PALABRAS = 20;
    let limpio = [];
    let buffer = "";
    for (const l of lineas) {
      const palabras = l.split(/\s+/).length;
      if ((buffer.split(/\s+/).length + palabras) < MIN_PALABRAS) {
        buffer += (buffer ? " " : "") + l;
      } else {
        if (buffer) limpio.push(buffer);
        buffer = l;
      }
    }
    if (buffer) limpio.push(buffer);
    texto = limpio.join("\n");

    // --- Calcular similitud global ---
    const { score, match } = calcularSimilitud(texto, frase);

    // --- Resaltar la cadena m√°s parecida ---
    const regex = new RegExp(match.replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&'), "gi");
    const resaltado = texto.replace(regex, m => `<mark>${m}</mark>`);

    resultado.innerHTML = `<p><b>Similitud:</b> ${score}%</p><hr>${resaltado}`;
    info.textContent = `‚úÖ An√°lisis completado. Similitud detectada: ${score}%`;
  } catch (err) {
    info.textContent = "‚ùå Error: " + err;
  }

  // Antes de ejecutar el HTML, actualizar sumario con "python actualizar_boja.py"
  
});
</script>
</body>
</html>

