<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BOJA Checker Inteligente</title>
<style>
body { font-family: sans-serif; background: #f8f9fa; margin: 2rem; color: #222; }
h1 { color: #005500; margin-bottom: 2rem; }
#controls { display: flex; flex-direction: column; gap: 1rem; max-width: 700px; }
input[type="text"] { padding: 10px; font-size: 1rem; border: 1px solid #ccc; border-radius: 6px; width: 100%; }
button { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; width: fit-content; }
button:hover { background: #218838; }
#info { margin-top: 2rem; font-weight: bold; }
#resultado { margin-top: 2rem; line-height: 1.6; white-space: pre-wrap; }
mark { background: #9f9; font-weight: bold; }
</style>
</head>
<body>
<h1>üìú Comprobador BOJA Inteligente</h1>

<div id="controls">
  <label for="textoBuscado"><b>Texto a buscar:</b></label>
  <input id="textoBuscado" type="text" 
       placeholder="Escribe aqu√≠ la frase que quieres buscar" 
       value="Subvenciones en r√©gimen de concurrencia no competitiva a organizaciones sindicales para la financiaci√≥n de gastos corrientes"
       style="width: 1000px">
  <button id="buscar">Buscar frase en el sumario</button>
</div>

<div id="info"></div>
<div id="resultado"></div>

<script>
// --- FUNCI√ìN DE SIMILITUD AVANZADA ---
function calcularSimilitudYResaltado(texto, frase) {
  const textoL = texto.toLowerCase();
  const fraseL = frase.toLowerCase();

  const palabrasTexto = textoL.split(/\W+/);
  const palabrasFrase = fraseL.split(/\W+/).filter(w => w.length > 1);

  let coincidencias = 0;
  let maxRacha = 0;
  let rachaActual = 0;
  let penalizacion = 0;

  for (let i = 0; i < palabrasFrase.length; i++) {
    const palabra = palabrasFrase[i];
    const encontrada = palabrasTexto.some(t => t === palabra);
    const parecida = palabrasTexto.some(t => t.startsWith(palabra.slice(0, Math.max(3, palabra.length * 0.6))));

    if (encontrada) {
      coincidencias++;
      rachaActual++;
      maxRacha = Math.max(maxRacha, rachaActual);
    } else if (parecida) {
      coincidencias += 0.5;
      rachaActual++;
      maxRacha = Math.max(maxRacha, rachaActual);
    } else {
      rachaActual = 0;
    }

    // penalizaci√≥n si la palabra "no" est√° en la frase pero no en el texto cerca de su palabra asociada
    if (palabra === "no" && !textoL.includes(" no ")) penalizacion += 10;
  }

  let base = (coincidencias / palabrasFrase.length) * 70;
  let bonus = (maxRacha / palabrasFrase.length) * 30;
  let similitud = Math.max(0, Math.min(100, Math.round(base + bonus - penalizacion)));

  // --- RESALTAR TODAS LAS PALABRAS INDIVIDUALES ---
  let textoMarcado = texto;
  const palabrasUnicas = [...new Set(palabrasFrase)];
  for (const palabra of palabrasUnicas) {
    if (palabra.length < 2) continue;
    const regex = new RegExp(`\\b(${palabra})\\b`, "gi");
    textoMarcado = textoMarcado.replace(regex, '<mark>$1</mark>');
  }

  return { similitud, textoMarcado };
}

document.getElementById("buscar").addEventListener("click", async () => {
  const frase = document.getElementById("textoBuscado").value.trim();
  const info = document.getElementById("info");
  const resultado = document.getElementById("resultado");
  info.textContent = "";
  resultado.textContent = "";

  if (!frase) { info.textContent = "‚ö†Ô∏è Escribe un texto antes de buscar."; return; }

  info.textContent = "üîç Cargando sumario...";
  try {
    let texto = await fetch("sumario.txt").then(r => r.text());

    // --- LIMPIEZA DEL TEXTO ---
    let lineas = texto.split(/\r?\n/);
    lineas = lineas.map(l => l.trim())
      .filter(l => l.length > 1)
      .filter(l => !/^[a-zA-Z0-9]$/.test(l))
      .filter(l => !/^https?:\/\//i.test(l));

    const MIN_PALABRAS = 5;
    let limpio = [];
    let buffer = "";
    for (const l of lineas) {
      const palabras = l.split(/\s+/).length;
      if ((buffer.split(/\s+/).length + palabras) < MIN_PALABRAS) {
        buffer += (buffer ? " " : "") + l;
      } else {
        if (buffer) limpio.push(buffer);
        buffer = l;
      }
    }
    if (buffer) limpio.push(buffer);
    texto = limpio.join("\n");

    // --- C√ÅLCULO Y RESULTADO ---
    const { similitud, textoMarcado } = calcularSimilitudYResaltado(texto, frase);
    resultado.innerHTML = `<p><b>Similitud estimada:</b> ${similitud}%</p><hr>${textoMarcado}`;
    info.textContent = `‚úÖ Sumario analizado. Nivel de similitud: ${similitud}%`;
  } catch(err) {
    info.textContent = "‚ùå Error: " + err;
  }

  // Antes de ejecutar el HTML, actualizar sumario con "python actualizar_boja.py"

});
</script>
</body>
</html>

